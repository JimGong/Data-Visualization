<!DOCTYPE html>
<meta charset="utf-8">
<style>

	svg {
		font: 10px sans-serif;
		padding: 10px;
	}

	.axis,
	.frame {
		shape-rendering: crispEdges;
	}

	.axis line {
		stroke: #ddd;
	}

	.axis path {
		display: none;
	}

	.frame {
		fill: none;
		stroke: #aaa;
	}

	circle {
		fill-opacity: .7;
	}

</style>
<head>
	<title>HW3_Scatter_Plot</title>
</head>
<body>
	<h1>HW3 Scatter Plot</h1>
	<!-- <h2>Scatter Plot Tableau prototype: <a href="https://public.tableau.com/shared/JTK2R24P2?:display_count=yes">link</a></h2> -->
	<!-- <h2>The follwing is what I have done in Code.</h2> -->

	<script src="//d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript">
		var width = 960,
		size = 150,
		padding = 19.5;

		var x = d3.scale.linear()
		.range([padding / 2, size - padding / 2]);

		var y = d3.scale.linear()
		.range([size - padding / 2, padding / 2]);

		var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.ticks(5);

		var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(5);

		var color = d3.scale.ordinal().range(["#ff7f0e","#7f7f7f"]);
    // var newData={};

    d3.csv("MarketHealthIndex_City_Filtered.csv", function(error, data) {
    	if (error) throw error;
      // console.log("data",data);
      // console.log("newData", newdata);

      var topTenState =  d3.nest()
      .key(function(d){return d.State})
      .rollup(function(c){
        // console.log("c",c)
        return d3.mean(c,function(e){
        	return e.MarketHealthIndex
        })
      })
      .entries(data);
      // console.log("topTenState",topTenState)

      topTenState = topTenState.sort(function(d,e){ 
      	return e.values-d.values
      })
      topTenState= topTenState.slice(0,10)
      console.log("topTenState",topTenState);

      function indexOf(State){
        // console.log("target: "+ State)
        for(var i=0; i<topTenState.length;i++){

          // console.log("topTenState[i].key", topTenState[i].key)
          if(topTenState[i].key === State){
            // console.log("find it.")
            return i;
          }
        }
        return -1;
      }

      // console.log("data[0].State: ",data[2].State.toString() )
      // console.log("index: ", indexOf(data[8].State))


      var tmp= data.filter(function(d){
      	var curState=d.State;
        // console.log("curState: ", curState);
        var myIndex= indexOf(curState)
        // console.log("i: ", myIndex);
        // console.log( myIndex !== -1);
        return myIndex!==-1;
      });
      // console.log("tmp", tmp)

      var tmp1 = tmp.sort(function(d,e){
      	return indexOf(d.State)-indexOf(e.State)
      })
      // console.log("sorted", tmp1);
      data=tmp1;
      // console.log("data",data)


      var domainByTrait={};
      traits = d3.keys(data[0]).filter(function(d) { 
        // console.log("d",d);
        return d === "YoY"||d==="MarketHealthIndex" ||d==="Delinquency"||d==="DaysOnMarket"; 
      }),
      n=traits.length
      // console.log("traits", traits)
      // console.log("n", n)
      // console.log("domainByTrait",domainByTrait)
      traits.forEach(function(trait){
      	// console.log("trait", trait)
      	var extent= d3.extent(data,function(d){
      		// console.log("d[trait]", d[trait])
      		return +d[trait];
      	})
      	// console.log("extent", extent);
      	domainByTrait[trait]= extent
      })
      // console.log("domainByTrait $$$$$$",domainByTrait)

      xAxis.tickSize(size * n);
      yAxis.tickSize(-size * n);

      // console.log("xAxis tickSize",xAxis.tickSize() )
      // console.log("yAxis tickSize",yAxis.tickSize() )

      var svg = d3.select("body").append("svg")
      .attr("width", size * n + padding)
      .attr("height", size * n + padding)
      .append("g")
      .attr("transform", "translate(" + padding + "," + padding / 2 + ")");
      console.log("domainByTrait",domainByTrait)

      var i=0;
      svg.selectAll(".x.axis")
      .data(traits)
      .enter().append("g")
      .attr("class", "x axis")
      .attr("transform", function(d, i) { return "translate(" + (n - i - 1) * size + ",0)"; })
      .each(function(d) { 
      	// console.log("d",d);
      	
      	x.domain(domainByTrait[d]); 
      	d3.select(this).call(xAxis)

      	// d3.select(this)
      	.append("text")
      	.attr("x", 50)
      	// .attr("y", 615)
      	.text(function(e){
          if (e.toString()==="YoY"){
            return "Year over Year"
          }else{
            return e;
          }
        })

      })


      svg.selectAll(".y.axis")
      .data(traits)
      .enter().append("g")
      .attr("class", "y axis")
      .attr("transform", function(d, i) { return "translate(0," + i * size + ")"; })
      .each(function(d) { 
      	y.domain(domainByTrait[d]); 
        // console.log("y domain", y.domain())
        d3.select(this).call(yAxis)
        .append("text")
        .attr("x", -110)
        .attr("y", 7)
        .text(function(e){
          if (e.toString()==="YoY"){
            return "YearOverYear"
          }else{
            return e;
          }
        })
        .attr("transform","rotate(-90)")


      });

      var cell = svg.selectAll(".cell")
      .data(cross(traits, traits))
      .enter().append("g")
      .attr("class", "cell")
      .attr("transform", function(d) { 
      	return "translate(" + (n - d.i - 1) * size + "," + d.j * size + ")";
      })
      .each(plot);

      cell.filter(function(d) { 
            // console.log("filted d:", d)
            return d.i === d.j; 
          })
      .append("text")
      .attr("x", padding)
      .attr("y", padding)
      .attr("dy", ".71em")
      .text(function(d) { 
        // console.log("text",d.x);
        if(d.x.toString()==="YoY"){
          return "YearOverYear";
        }else{
          return d.x
        }
      });

      var legend= svg.selectAll(".legend")
      .data(color.domain().slice().reverse())
      .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
      .attr("x", 530)
      .attr("y", 100)
      .attr("width",65)
      .attr("height", 18)
      .style("fill", color);

      legend.append("text")
      .attr("x", 590)
      .attr("y", 110)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .style("font-weight","bold")
      .text(function(d) { 
      	if(d.toString()==="true"){
      		return "California";
      	}
      	else{
      		return "Other States";
      	}
      });


      function plot(p) {
      	var cell = d3.select(this);

      	x.domain(domainByTrait[p.x]);
      	y.domain(domainByTrait[p.y]);

      	cell.append("rect")
      	.attr("class", "frame")
      	.attr("x", padding / 2)
      	.attr("y", padding / 2)
      	.attr("width", size - padding)
      	.attr("height", size - padding);

      	cell.selectAll("circle")
      	.data(data)
      	.enter().append("circle")
      	.attr("cx", function(d) { return x(d[p.x]); })
      	.attr("cy", function(d) { return y(d[p.y]); })
      	.attr("r", 3)
      	.style("fill", function(d) { 
      		return color(d.State==="CA"); 
      	})
      	.style("fill-opacity", 0.42);
      }

      function cross(a, b) {
      	var c = [], n = a.length, m = b.length, i, j;
      	for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
      		return c;
      }

      d3.select(self.frameElement).style("height", size * n + padding + 20 + "px");

    });

  </script>
  <h4>P.S. Other states include the top ten State that have the highest avg market health index.</h4>
  <h4>1.TX 2.CO 3.NE 4.CA 5.WI 6.WA 7.IA 8.OK 9.OR</h4>
  <h3>Conclusion: For California, with the increase of days on market, delinquency also increase.</h3>

  <h2>Customization: </h2>
  <h3>1. Change the color scale.</h3>
  <h3>2. Adding text annotations.</h3>
  <h3>3. Adjusting legends.</h3>
  <h3>4. Adjusting tick marks. YoY to YearOverYear</h3>
  <!-- <h3>5. Change the formatting of axis lines.</h3> -->
  <h3>5. Add a general conclusion about the data.</h3>
  <!-- <h1>Bubble Plot Tableau Prototype: <a href="https://public.tableau.com/shared/HM8WSG2XZ?:display_count=yes">link</a></h1> -->

</body>