<!DOCTYPE html>
<meta charset="utf-8">
<title>HW2_StackedAreaChart</title>
<style>

  body {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .browser text {
    text-anchor: end;
  }

  .area{
    fill: steelblue;
    stroke: #000;
  }

  path{
    fill: steelblue;
    stroke: #000;
  }
  .path{
    fill: steelblue;
    stroke: #000;
  }

  h2{
    padding-left: 300px;
  }


</style>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    var margin = {top: 20, right: 50, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

    var x = d3.time.scale().range([0,width]);

    var y = d3.scale.linear().range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

    formatPercent = d3.format(".0%");

    var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(formatPercent);

    var parseDate=d3.time.format("%m/%d/%Y").parse;

    var nest = d3.nest()
    .key(function(d) { 
      // console.log("key", d.Date);
      return d.Date;
    })
    .rollup(function(c){
      return d3.sum(c,function(d){return d.Incidents});
    })

    var area = d3.svg.area()
    .x(function(d) { 
      // console.log("x",d.key);
      return x(new Date(d.key)); 
    })
    .y0(function(d){
      // console.log("y0",d.y0);
      return y(d.y0);
    })
    .y1(function(d) { 
      // console.log("y1", d.y0+d.y)
      return y(d.y0 +d.y);
    });

    var stack =d3.layout.stack()
    .values(function(d){
      // console.log("values", d.values);
      return d.values;
    })
    // .x(function(d){
    //   // console.log("x", d.key);
    //   return d.key;
    // })
    .y(function(d){
      // console.log("y",d.values);
      return d.values;
    })
    // .order(function(data){
    //   // console.log("%%%", data);
    //   return d3.range(data.length).reverse();
    // });



    var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    // .attr("fill", "black");

    d3.csv("sfpd-property-crimes-2005-2015.csv",function(error, data){
      if(error) throw error;

      data.forEach(function(d){

        d.Date=parseDate(d.Date);

        d.Incidents= parseInt(d.Incidents);
      })

      var temp= d3.map(data, function(d){return d.Category})
      // console.log("temp", temp);
      var e= temp.keys();
      color.domain(e);
      // console.log("color domain", color.domain())

      var totalCrimesByMonth=d3.nest()
      .key(function(d){return d.Date})
      .rollup(function(c){
        return d3.sum(c,function(e){return e.Incidents});
      })
      .entries(data);
      console.log("totalCrimesByMonth", totalCrimesByMonth);
      var date;

      var getValue=function(date){
        for(var i=0;i<totalCrimesByMonth.length;i++){
          if(totalCrimesByMonth[i].key.toString()===date.toString()){
            // console.log("find it!!!!!!!")
            return totalCrimesByMonth[i].values;
          }
        }
      }


      var crimes= d3.nest()
      .key(function(d){return d.Category})

      .key(function(d){return d.Date})
      // .key(function(d){return d.Category})
      .rollup(function(c){
        // console.log("c", c);
        var sum=d3.sum(c, function(e){
          date=e.Date
          return e.Incidents;
        })
        // sum=sum/100;
        var denominator = getValue(date);
        // return sum
        return sum/denominator;
      })
      .entries(data);

      console.log("crimes",crimes);

      crimes= sort_crimes(crimes);

      function sort_crimes(crimes){
        return crimes.sort(function(a,b){
          // console.log("a",a);
          var aSum=0;
          a.values.forEach(function(d){
            // console.log("wtf",d.values);
            aSum=d.values+ aSum;
          })
          // console.log("aSum", aSum);
          var bSum=0;
          b.values.forEach(function(d){
            // console.log("")
            bSum=d.values+bSum;
          })
          // console.log("b",b);
          return bSum-aSum;
        })
      }
      console.log("sorted crimes", crimes);
      
      var layers =stack(crimes);
      console.log("layers", layers)
      // console.log("color domain", color.domain());

      x.domain(d3.extent(data,function(d){return d.Date}));

      // console.log("-----color domain", color.domain());

      svg.selectAll(".layer")
      .data(layers)
      .enter().append("path")
      .attr("class","layer")
      .attr("d",function(d){
        return area(d.values);
      })
      .style("fill", function(d){
        return color(d.key);
      })

      svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

      svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

      var rectangle=svg.append("rect")
      .attr("x",70)
      .attr("y",260)
      .attr("width", 180)
      .attr("height", 140)
      .attr("fill", "white")
      .style("opacity",0.75)


      var legend= svg.selectAll(".legend")
      .data(color.domain())
      .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
      .attr("x", 160)
      .attr("y", 270)
      .attr("width", 80)
      .attr("height", 18)
      .style("fill", function(d){
        // console.log(d);
        return color(d);
      })
      .style("opacity");

      // console.log("color domain", color.domain());

      legend.append("text")
      .attr("x", 150)
      .attr("y", 275)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { 
        // console.log("d text",d);
        return d; });
    });
  </script>
  <h2>Larceny is the most likely crime to happen.</h2>
</body>


