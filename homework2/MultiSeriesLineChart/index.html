<!DOCTYPE html>
<meta charset="utf-8">
<title>HW2_MultiSerisLine</title>
<style type="text/css">
	body{
		font: 10px sans-serif;
	}
	.axis path,
	.axis line{
		fill: none;
		stroke: #a9a9a9;
		shape-rendering: crispEdges;
	}

	.line{
		fill: none;
		stroke: steelblue;
		stroke-width: 1.5px;
	}

	svg{
		fill: whitesmoke;
	}

	.axis text{
		fill: #a9a9a9;
	}
	h2{
		padding-left: 6cm;
	}
	h3{
		padding-left: 3.5cm;
	}
</style>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>  
	<script type="text/javascript">
		var margin = {top: 20, right: 50, bottom: 30, left: 50},
		width = 960 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom;

		var x = d3.time.scale().range([0,width]);

		var y = d3.scale.linear().range([height, 0]);

		var color = d3.scale.category10();

		var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom");

		var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left");

		var parseDate=d3.time.format("%m/%d/%Y").parse;

		var line =d3.svg.line()
		.interpolate("linear")
		.x(function(d){
			return x(new Date(d.key));
		})
		.y(function(d){
			return y(d.values);
		})

		function findMaxMin(crimes){
			var result={};
			var lar= crimes[2].values;
			var curMax=0;
			var maxDate;
			var curMin=1000000;
			var minDate;
			for(var i=0; i< lar.length; i++){
				if(curMax< lar[i].values){
					curMax = lar[i].values;
					maxDate= lar[i].key;
				}
				if(curMin> lar[i].values){
					curMin= lar[i].values;
					minDate= lar[i].key
				}
			}
			// console.log("curMax",curMax);
			// console.log("date", maxDate);

			// console.log("curMin", curMin);
			// console.log("date", minDate);

			result.larMaxDate = maxDate;
			result.larMax= curMax;
			result.larMinDate= minDate;
			result.larMin= curMin;

			var vt = crimes[5].values;
			var curMax=0;
			var maxDate;
			var curMin=1000000;
			var minDate;
			for(var i=0; i< vt.length; i++){
				if(curMax< vt[i].values){
					curMax = vt[i].values;
					maxDate= vt[i].key;
				}
				if(curMin> vt[i].values){
					curMin= vt[i].values;
					minDate= vt[i].key
				}
			}
			// console.log("curMax",curMax);
			// console.log("date", maxDate);

			// console.log("curMin", curMin);
			// console.log("date", minDate);

			result.vtMaxDate=maxDate;
			result.vtMax= curMax;
			result.vtMinDate= minDate;
			result.vtMin= curMin;
			return result;


		}

		var svg =d3.select("body").append("svg")
		.attr("width", width+margin.left+margin.right)
		.attr("height", height + margin.top+margin.bottom);

		svg.append("rect")
		.attr("width", "100%")
		.attr("height", "100%");

		svg =svg.append("g")
		.attr("transform", "translate("+margin.left+","+margin.top+")");

		d3.csv("sfpd-property-crimes-2005-2015.csv",function(error, data){
			if(error) throw error;

			data.forEach(function(d){

				d.Date=parseDate(d.Date);

				d.Incidents= parseInt(d.Incidents);
			})

			var d= d3.map(data, function(d){return d.Category})
			var e= d.keys();
			color.domain(e);

			var crimes= d3.nest()
			.key(function(d){return d.Category})
			.key(function(d){return d.Date})
			.rollup(function(c){
				return d3.sum(c, function(e){
					return e.Incidents;
				})
			})
			.entries(data);
			// console.log(crimes);
			var minMax= findMaxMin(crimes);
			console.log("minMax", minMax);

			var myMin=d3.min(crimes, function(c){
				return d3.min(c.values,function(v){
					return v.values;
				})
			});
			var myMax=d3.max(crimes, function(c){
				return d3.max(c.values,function(v){
					return v.values
				})
			});

			x.domain(d3.extent(data,function(d){return d.Date}));
			y.domain([myMin,myMax]);


			svg.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis)
			.append("text")
			.attr("x",width)
			.attr("y", 15)
			.text("Year");

			svg.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("x", -30)
			.attr("y", -6)
			.text("Crime");
			console.log("maxdate",minMax["larMax"]);

			var crime =svg.selectAll(".crime")
			.data(crimes)
			.enter().append("g")
			.attr("class", "crime");

			crime.append("path")
			.attr("class", "line")
			.attr("d", function(d) { 
				return line(d.values); })
			.style("stroke", function(d) { 
				return color(d.key); 
			});

			crime.append("text")
			.attr("class", "text")
			.attr("d",function(){return minMax})

			var points=crime.append("g")
			.attr("class", "line-point");
			points.selectAll('circle')
			.data(function(d){return d.values})
			.enter().append('circle')
			.attr("cx",function(d){return x(new Date(d.key))})
			.attr("cy",function(d){return y(d.values)})
			.attr("r",1.5)
			.style("stroke",function(d){return color(this.parentNode.__data__.key)})

			var legend= svg.selectAll(".legend")
			.data(color.domain().slice().reverse())
			.enter().append("g")
			.attr("class", "legend")
			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

			legend.append("rect")
			.attr("x", 10)
			.attr("width", 80)
			.attr("height", 18)
			.style("fill", color);

			legend.append("text")
			.attr("x", 80)
			.attr("y", 9)
			.attr("dy", ".35em")
			.style("text-anchor", "end")
			.text(function(d) { 
				return d; });

			svg.append("text")
			.attr("x", x(new Date(minMax["larMaxDate"])))
			// .attr("x", 826-10-10)
			.attr("y", y(minMax["larMax"]) )
			.text(function(){return minMax["larMax"]})
			.attr("fill", function(d){return color("Larceny")});

			svg.append("text")
			.attr("x", x(new Date(minMax["larMinDate"])))
			// .attr("x", 826-10-10)
			.attr("y", y(minMax["larMin"]) )
			.text(function(){return minMax["larMin"]})
			.attr("fill", function(d){return color("Larceny")});

			svg.append("text")
			.attr("x", x(new Date(minMax["vtMaxDate"])))
			// .attr("x", 826-10-10)
			.attr("y", y(minMax["vtMax"]) )
			.text(function(){return minMax["vtMax"]})
			.attr("fill", function(d){return color("Vehicle Theft")});

			svg.append("text")
			.attr("x", x(new Date(minMax["larMinDate"])))
			// .attr("x", 826-10-10)
			.attr("y", y(minMax["vtMin"]) )
			.text(function(){return minMax["larMin"]})
			.attr("fill", function(d){return color("Vehicle Theft")});

		});

	</script>

	<h2>Multi-Series Line Chart Showing Date by Incidents</h2>

	<h3>Larceny is the most likely crime to happen from Jan 2005 to Dec 2015 according to SF OpenData.</h3>

</body>