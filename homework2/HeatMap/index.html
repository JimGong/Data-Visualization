<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<link href="style.css" rel="stylesheet" type="text/css">
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="colorbrewer.js"></script>
	<script src="heatmap.js"></script>
</head>
<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>  
	<script type="text/javascript">
		var translate = function(x, y) { return "translate(" + x + "," + y + ")"; };

		var config = {};
		config.svg = {width: 960, height: 500};
		config.margin = { top: 50, right: 10, bottom: 20, left: 40};

		config.plot = {
			width: config.svg.width - config.margin.right - config.margin.left,
			height: config.svg.height - config.margin.top - config.margin.bottom
		};

		config.legend = {
			width: 100,
			height: 15
		};

		// create svg based on config
		var svg = d3.select("body").append("svg")
		.attr("width", config.svg.width)
		.attr("height", config.svg.height);

		// create plot area based on config
		var plot = svg.append("g")
		.attr("id", "plot")
		.attr("transform", translate(config.margin.left, config.margin.top));

		var xScale = d3.scale.ordinal()
		.rangeBands([0, config.plot.width], 0, 0);

		var yScale = d3.scale.ordinal()
		.rangeBands([config.plot.height, 0], 0, 0);

		var colorScale = d3.scale.linear()
		.range(colorbrewer.YlGnBu[3]);

		var dateFormat =d3.time.format("%m/%d/%Y");

		var yearFormat = d3.time.format("%Y");
		var monthFormat = d3.time.format("%b");
		var weekdayFormat = d3.time.format("%w");

		// placeholder for data
		var dataset= [];

		function minMax(c){
			var curWeekDayMax;
			var curWeekDayMin;
			var curMonthMax;
			var curMonthMin;

			var curMin=1000000;
			var curMax=0;
			var monthlist = ["Dec","Nov","Oct","Sep","Aug","Jul","Jun","May","Apr","Mar","Feb","Jan"];
			var weekdaylist = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
			// console.log("wtf",c.length())
			for(var i=0;i< 12;i++){
				// console.log(monthlist[i]);
				// console.log("get Dec",c.get(monthlist[i]))
				var curMonth= c.get(monthlist[i]);
				// console.log(curMonth);
				for(var j=0;j<6;j++){
					// console.log(weekdaylist[j]);
					// console.log(curMonth.get(weekdaylist[j]));

					var curCrime=curMonth.get(weekdaylist[j]);
					// console.log(curCrime);
					if(curMax<curCrime){
						curMax=curCrime;
						curWeekDayMax=weekdaylist[j];
						curMonthMax= monthlist[i];
						// console.log("curWeekDay", curWeekDayMax);
					}
					if(curMin>curCrime){
						curMin=curCrime
						curWeekDayMin=weekdaylist[j];
						curMonthMin= monthlist[i];
					}
				}
			}
			// console.log("curMax", curMax);
			// console.log("Weekday", curWeekDayMax);
			// console.log("Month", curMonthMax);

			// console.log("curMin", curMin);
			// console.log("Weekday", curWeekDayMin);
			// console.log("Month", curMonthMin);

			return {curMax: curMax, maxWeekday: curWeekDayMax, maxMonth: curMonthMax, curMin: curMin, minWeekday: curWeekDayMin, minMonth: curMonthMin};
		}

		d3.csv("sfpd-property-crimes-2005-2015.csv",function(error, data){
			if(error) throw error;
			// console.log("original data", data);

			data.forEach(function(d){
				d.Date =dateFormat.parse(d["Date"]);
				d.month = monthFormat(d.Date);
				d.Incidents=parseInt(d.Incidents);
				d.type  = d["Category"];
			})
			// console.log("data",data);

			var c= d3.nest()
			.key(function(d){return d.month})
			.key(function(d){return d.Weekday})
			.rollup(function(d){
				return d3.sum(d,function(e){return e.Incidents})
			})
			.map(data, d3.map);
			// .entries(data)
			console.log("c",c);
			// var e= c.map(function(d){return d});
			// console.
			var minMaxs= minMax(c);
			console.log("minMaxs",minMaxs);

			dataset=c;

			data=c;

			var months = data.keys();
			months=sort_months(months);
			// console.log("months", months)
			var weekdays = data.get(months[0]).keys();
			weekdays=sort_days(weekdays);
			// console.log("weekdays", weekdays);

			function sort_months(months) {
				var list = ["Dec","Nov","Oct","Sep","Aug","Jul","Jun","May","Apr","Mar","Feb","Jan"];
				return months.sort(function(a,b) { return list.indexOf(a) - list.indexOf(b); });
			}


			function sort_days(days) {
				var list = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
				return days.sort(function(a,b) { return list.indexOf(a) > list.indexOf(b); });
			}

			xScale.domain(weekdays);
			yScale.domain(months);

			var values = data.values();
			// console.log("values", values);

			values = values.map(function(d) { return d.values(); });
			// console.log("values", values);

			values = d3.merge(values);
			// console.log("values", values);

			var min = d3.min(values);
			var max = d3.max(values);
			var avg = d3.mean(values);

			colorScale.domain([min, avg, max]);

			drawBackground();
			drawAxes();
			drawHeatmap();
			drawTitle();
			drawLegend();

			// var xvalue= d3.time.scale().range([0, config.plot.width]);
			// var yvalue= d3.scale.linear().range([config.plot.height,0]);

			// xvalue.domain(weekdays);
			// yvalue.domain(months);

			// console.log("minMaxs", minMaxs)
			// var maxMonth=minMaxs["maxMonth"];
			// console.log("getMonth", maxMonth);
			// console.log("scale", xvalue(maxMonth.toString()))
			// console.log("x" , xScale(maxMonth));

			// console.log("getMonth", minMaxs["minMonth"])
			// var yvalue= yScale(minMaxs["maxWeekday"]);

			// console.log(config.plot.width)
			// console.log("wtf",minMaxs["maxMonth"])
			// console.log()

			
			svg.append("text")
			.attr("x", 610)
			.attr("y", 325)
			.text(function(){return minMaxs["curMax"]})

			svg.append("text")
			.attr("x", 870)
			.attr("y", 110)
			.text(function(){return minMaxs["curMin"]})
		});
	</script>
	<h5>Friday is when most crimes probably happens.</h5>
</body>